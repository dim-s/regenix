# Роуйтинг (ЧПУ)

В патерне проектирования MVC действия контроллера всегда вызываются с помощью URL.
Связывание действий и URL называется `Роутинг`. В Regenix существует только один
способ для реализации этого. Фреймворк имеет специальный тип конфигурации для роутинга.
Данная конфигурация располагается в файле `conf/route`.

---

## Вступление

Типичный http-запрос состоит из следующей информации:

+ `протокол` - http или https
+ `хост` - или домен, пример: `example.com`
+ `порт` - http порт, по-умолчанию = 80
+ `путь` - строка после хоста и порта, пример `/news/list`.
+ `query` - строка после строки пути и символа `?`, пример `id=2&open=true`
+ `метод` - POST, GET, PUT, etc.

Вся эта информация использяется для переправления http-запросов на действия контроллеров.

---

## REST Архитектура

Representational State Transfer (REST) это одна из архитектур Веб - Приложений.
REST основан на следующих вещах:

1. Приложения поделено на ресурсы
2. Доступ к каждому ресурсу осуществляется через URI
3. Все ресурсы имеют один интерфейс для передачи состояни между клиентом и ресурсами.

Если приложение следует этим принципам REST тогда его можно называть REST-подобным.
Regenix позволяет создавать такие приложения не прилагая больших усилий.

+ Роутинг в Regenix обеспечивает связывание ссылок (URLs) и методов контроллеров.
  Также поддерживаются регулярные выражения, благодаря этому вы сможете задавать более гибкие правила.
+ Фреймворк не сохраняет состояние. Это означает что вы не можете сохранить состояние на сервере между двумя запросами.
+ Regenix позволяет получить всю информацию о любом http запросе.

---

## Конфигурирование

Есть специальный конфигурационный файл в директории приложения - `conf/route`. Этот файл следующего формата:

    <METHOD>       <PATH>       <ACTION_NAME>

Здесь:

+ `METHOD` может быть POST, GET, PUT, DELETE, PATCH, OPTIONS, HEAD или `*` для любого метода.
+ `PATH` - абсолютный путь к URL, пример: `/news/123`
+ `ACTION_NAME` - строка, содержащая имя класса контроллера и имя его метода.

Чтобы понять данный формат, вы можете взглянуть на следующий пример:

    *     /             Application.index

    GET   /news/        News.index
    GET   /news/{id}    News.detail

Здесь объявлено три правила: два из них для статичных URL и одно для динамичного URL с аргументом `id`.
`Application.index`, `News.index` и `News.detail` это названия действий, первая часть это имя класса контроллера,
последняя часть это имя метода данного класса.

> Чтобы понять это лучше вы должны прочитать о контроллерах в Regenix.

Контроллер `Application` будет выглядеть как показано ниже:

    <?php
    namespace controllers;

    use regenix\mvc\Controller;

    class Application extends Controller {
      public function index(){
        // action method
      }
    }

Когда вы откроете ваше приложение в браузере, будет создан экземпляр класса `Application` и
вызван его метод `index`.

---

## HTTP Методы

Regenix поддержиывает все http методы в конфиге: `GET`, `POST`, `PUT`, `DELETE`,
`PATCH`, `OPTIONS`, `HEAD`. Однако, если вы хотите связать одно действие со всеми http методами,
используйте специальный символ - `*`. Этот символ означает, что все http запросы будут ассоциированы
с одним действием.

---

## URI правило

URI правило определяет путь запроса в роутинге. Некоторые части этого пути могут быть динамичными.
Если вы хотите чтобы метод контроллера вызывался по открытию некого URL, посмотрите на следующий пример:

    GET    /news/       NewsController.index

Здесь мы объявили `/news/` URL, который ассоциирован с контроллером `controllers\NewsController` и
его методом `index`. Этот URL будет доступен только через `GET` метод. Данное правило не имеет динамических
частей. Далее мы рассмотрим URI правила, содержащее динамические части.

---

##### Динамический части

Для примера детальная страница новостей:

    GET   /news/{id}    NewsController.detail

Здесь у нас `id` динамическая часть. Динамические части заключаеются в фигурные скобки `{...}`.
По-умолчанию динамичаская часть соответствует регулярному выражению `[^/]+`. Чтобы достать
значени динамических частей, используйте аргументы метода контроллера, для примера:

    public function detail($id){
        // $id равняется значению `{id}` из URI правила:     GET   /news/{id}    NewsController.detail
    }

Имена аргументов метода соответствуют именам динамических частей из роутинга. Посмотрите на несколько
примеров:

    GET   /news/{category}/{id}     NewsController.detail 
    
    public function detail($category, $id){
        ...
        
        $this->render();
    }

Вы можете использовать значения по-умолчанию:

    public function detail($category = 'common', $id){
        // если правило роутинга не будет содержать дин. часть `category` значит `$category` будет равена `common`.
    }

---

#### Регулярные выражения

Иногда вам необходимо использовать регулярные выражения в правилах URI. Regenix имеет такую
возможность. Для примера:

    GET   /news/{id<[0-9]+>}      NewsController.detail

Здесь мы задали `id` как числовое значение через регулярное выражение - `[0-9]+`. Чтобы задать
регулярное выражение для динамической части используйте следующий синтаксис: `{имя<рег.выражение>}`.

---

#### Бэкслешы, косая чарта (/) на конце URL

Довольно часто требуется чтобы URL мог открываться как со слешом на конце, так и без. Это легко реализовать,
используйте символ регулярных выражений `?` на конце правила URI:

    GET   /news/?       NewsController.detail

Ссылка `/news/` будет также доступна по адресу `/news` (без слеша на конце).

---

#### Генерация URL

Вы легко можно сгенерировать URL используя статичный метод `Router::path()`. Это означает, что
URL может быть сгенерирован с помощью имени метода и его параметров. Regenix пытается найти
правило роутинга и развернуть его в URL. Посмотрите на следующий пример:

    GET   /news/{id}    NewsController.detail

    $url = Router::path('NewsController.detail', array('id' => 123));
    // $url будет равно `/news/123`

Метод `path` довольно гобок для развертки сложны правил.

**Как сгенерировать URL в шаблонах?**

Regenix шаблоны имеют специальный тег для этого - `{path ...}`. Изучите следующий пример:

    <a href="{path 'NewsController.detail', id: 123}">detail link</a>

Читайте больше об этом в разделе [шаблоны](views.md).

---

## Как добавить новое правило динамически?

Вы можете добавить новое правило не используя конфиг файл `conf/route`. Для этого используйте
объект класса `Router` и его метод `addRoute`:

    public function addRoute($method, $path, $action, $params = '')

Чтобы получить объект роуйтера используйте DI или свойство Application - `router`:

    $router = Regenix::app()->router;
    $router->addRoute('GET', '/news/{id}', 'NewsController.detail');

Или используя внедрение зависимости (DI):

    $router = DI::getInstance(Router::type);
    $router->addRoute('GET', '/news/{id}', 'NewsController.detail');

Читайте о DI в [этом разделе](di.md).

---

## Приоритет правил

Бывают ситуации, когда один запрос может соответствовать нескольким правилам роутинга.
Если произойдет данный конфликт, будет использовано первое правило (в порядке объявления).